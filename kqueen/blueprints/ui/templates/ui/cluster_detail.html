{% extends "ui/base.html" %}

{% from "ui/partial/form.html" import render_form %}

{% block page_header %}
Cluster {{ cluster.name }} detail
{% endblock %}


{% block content %}
<div class="box overview" style="margin-bottom: 20px;">
  <div class="col-sm-4">
    <a href="{{ url_for('api.cluster_kubeconfig', cluster_id=cluster.id) }}" class="btn btn-primary btn-xs">Download kubeconfig</a>
  </div>
  <div class="col-sm-4" id="state">
    <a class="btn btn-{{ state_class }} btn-xs" style="pointer-events: none;">State: {{ cluster.state }}</a>
  </div>
  <div class="col-sm-4" id="progress">
    {% if cluster.state == 'Deploying' %}
      {% set initial_progress = 1 %}
    {% else %}
      {% set initial_progress = 100 %}
    {% endif %}
    <div class="progress-bar-background">
      <span>{% if cluster.state == 'Deploying' %}{{ initial_progress }}%{% else %}Done{% endif %}</span>
      <div class="progress-bar" style="width: {{ initial_progress }}%;"></div>
    </div>
  </div>
</div>

<div class="box overview" style="min-height: 160px; padding: 10px;">
  <div class="col-sm-2 col-sm-offset-1 clearfix">
    <div class="pie_progress" role="progressbar" data-goal="2" aria-valuemax="2">
      <div class="pie_progress__number">0</div>
      <div class="pie_progress__label">Namespaces</div>
    </div>
  </div>
  {% if 'nodes' in status %}
    {% set nodecount = status.nodes|length %}
  {% else %}
    {% set nodecount = 0 %}
  {% endif %}
  <div class="col-sm-2 clearfix">
    <div class="pie_progress" role="progressbar" data-goal="{{ nodecount }}" aria-valuemax="{{ nodecount }}"> 
      <div class="pie_progress__number">0</div>
      <div class="pie_progress__label">Nodes</div>
    </div>
  </div>
  {% if 'deployments' in status %}
    {% set deploymentcount = status.deployments|length %}
  {% else %}
    {% set deploymentcount = 0 %}
  {% endif %}
  <div class="col-sm-2 clearfix">
    <div class="pie_progress" role="progressbar" data-goal="{{ deploymentcount }}" aria-valuemax="{{ deploymentcount }}"> 
      <div class="pie_progress__number">0</div>
      <div class="pie_progress__label">Deployments</div>
    </div>
  </div>
  {% if 'pods' in status %}
    {% set podcount = status.pods|length %}
  {% else %}
    {% set podcount = 0 %}
  {% endif %}
  <div class="col-sm-2 clearfix">
    <div class="pie_progress" role="progressbar" data-goal="{{ podcount }}" aria-valuemax="{{ podcount }}"> 
      <div class="pie_progress__number">0</div>
      <div class="pie_progress__label">Pods</div>
    </div>
  </div>
  {% if 'services' in status %}
    {% set servicecount = status.services|length %}
  {% else %}
    {% set servicecount = 0 %}
  {% endif %}
  <div class="col-sm-2 clearfix">
    <div class="pie_progress" role="progressbar" data-goal="{{ servicecount }}" aria-valuemax="{{ servicecount }}"> 
      <div class="pie_progress__number">0</div>
      <div class="pie_progress__label">Services</div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs{% if cluster.state != 'OK' %} hidden{% endif %}">
  <li role="presentation" class="active"><a data-toggle="tab" href="#status">Status</a></li>
  <li role="presentation"><a data-toggle="tab" href="#topology">Topology</a></li>
  <li role="presentation"><a data-toggle="tab" href="#addons">Addons</a></li>
</ul>

<div class="tab-content clearfix{% if cluster.state != 'OK' %} hidden{% endif %}">
  {# STATUS TAB #}
  <div class="tab-pane active" id="status">
    {% if 'nodes' in status %}
    <h3>Nodes</h3>
    <div class="table-container">
      <table class="table table-hover no-actions" id="table-nodes">
        <thead>
          <tr>
            <th>Name</th>
            <th>IP</th>
            <th>OS</th>
            <th class="status_column">Status</th>
            <th>Size</th>
            <th colspan=2 class="action_column">Pods</th>
          </tr>
        </thead>
        <tbody>
        {% for node in status.nodes %}
          <tr>
            <td>{{ node['metadata']['name'] }}</td>
            <td>
              <ul>
                {% for a in node['status']['addresses'] %}
                  {% if a['type'] not in ['LegacyHostIP', 'InternalDNS', 'ExternalDNS', 'Hostname'] %}
                    <li>{{ a['type'] }}: {{ a['address'] }}</li>
                  {% endif %}
                {% endfor %}
              </ul>
            </td>
            <td>{{ node['status']['node_info']['os_image'] }}<br>{{ node['status']['node_info']['kernel_version'] }}</td>
            <td class="status_column">
              {% for s in node['status']['conditions'] %}
                {% if s['type'] != 'Ready' %}
                  {% if s['status'] == 'False' %}
                    {% set icon = 'ok' %}
                  {% else %}
                    {% set icon = 'remove' %}
                  {% endif %}
                <abbr title="{{ s['type'] }}"><span class="glyphicon glyphicon-{{ icon }}" aria-hidden="true"></span></abbr>
                {% endif %}
              {% endfor %}
            </td>
            <td>
            {{ node['status']['allocatable']['cpu'] }} / {{ '%.02f GB' % (node['status']['allocatable']['memory'].replace('Ki', '')|int/1000000)  }}
            </td>
            {% set maxpods = node['status']['allocatable']['pods']|int %}
            {% set pods = status.nodes_pods.get(node['metadata']['name'])|int %}
            {% set percentage = (pods/maxpods*100)|int %}
            <td class="action_column">
              <div class="progress-bar-background">
                <span>{{ pods }}/{{ maxpods }}</span>
                <div class="progress-bar" style="width: {{ percentage }}%;"></div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    
    {% if 'deployments' in status %}
    <h3>Deployments</h3>
    <div class="table-container">
      <table class="table table-hover no-actions" id="table-nodes">
        <thead>
          <tr>
            <th>Name</th>
            <th>Namespace</th>
            <th>Replicas</th>
            <th>Containers</th>
          </tr>
        </thead>
        <tbody>
        {% for deployment in status.deployments %}
          <tr>
          <td>{{ deployment['metadata']['name'] }}</td>
          <td>{{ deployment['metadata']['namespace'] }}</td>
          <td>
            {% set ready = deployment.get('status', {}).get('ready_replicas', 'N')|int %}
            {% set desired = deployment.get('spec', {}).get('replicas', 'N')|int %}
            {% if desired > 0 %}
              {% set percentage = (ready/desired*100)|int %}
            {% else %}
              {% set percentage = 0|int %}
            {% endif %}
            <div class="progress-bar-background">
              <span>{{ ready }}/{{ desired }}</span>
              <div class="progress-bar" style="width: {{ percentage }}%;"></div>
            </div>
          </td>
          <td>
          {% set containers = deployment.get('spec', {}).get('template', {}).get('spec', {}).get('containers') %}
          <ul>
          {% for container in containers %}
            <li><b>{{ container['name'] }}</b> {{ container['image'] }}</li>
          {% endfor %}
          </ul>
          </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}


    {% if 'services' in status %}
    <h3>Services</h3>
    <div class="table-container">
      <table class="table table-hover no-actions" id="table-nodes">
        <thead>
          <tr>
            <th>Name</th>
            <th>Namespace</th>
            <th>Cluster IP</th>
            <th>Ports</th>
            <th>External IP</th>
          </tr>
        </thead>
        <tbody>
          {% for service in status.services %}
          <tr>
            <td>{{ service['metadata']['name'] }}</td>
            <td>{{ service['metadata']['namespace'] }}</td>
            <td><a href="http://{{ service['spec']['cluster_ip'] }}">{{ service['spec']['cluster_ip'] }}</a></td>
            <td>
              <ul>
              {% set ports = service['spec']['ports'] %}
              {% if ports %}
              {% for port in ports %}
                <li>{{ port['port'] }}/{{ port['protocol'] }} {{ port.get('name', '') }}</li>
              {% endfor %}
              {% endif %}
              </ul>
            </td>
            <td>
            {% if service.get('status', {}).get('load_balancer', {}).get('ingress') %}
              {% for endpoint in service['status']['load_balancer'].get('ingress', []) %}
                {% if endpoint.get('hostname') %}
                  {% for port in service['spec']['ports'] %}
                    <a href="{{ port['name'] }}://{{ endpoint['hostname'] }}:{{ port['port'] }}">{{ endpoint['hostname']|truncate(20, True) }}:{{ port['port'] }} {{ port['name']|upper }}</a>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
  </div>
  {# TOPOLOGY TAB #}
  <div class="tab-pane" id="topology">
    <div class="col-xs-9">
      <div id="ForcedLayoutGraphContainer">
        <div id="topology-graph"></div>
      </div>
      <div id="HiveGraphContainer" class="">
        <div id="HiveChart"></div>
      </div>
    </div>
    <div class="col-xs-3 topology-tooltip">
      <h3>Topology Layout</h3>
      <div class="btn-group">
        <button id="ForcedLayoutGraphBtn" type="button" class="btn btn-primary active">Force-directed</button>
        <button id="HiveGraphBtn" type="button" class="btn btn-primary">Hive Plot</button>
      </div>
      <h3>Topology Resources</h3>
      <div class="topology-legend">
        <div>
          <svg class="kindInfo">
            <use xlink:href="#vertex-Pod" x="15" y="15"></use>
          </svg>
          <div>Pods</div>
        </div>
        <div>
          <svg class="kindInfo">
            <use xlink:href="#vertex-Service" x="15" y="15"></use>
          </svg>
          <div>Services</div>
        </div>
        <div>
          <svg class="kindInfo">
            <use xlink:href="#vertex-Node" x="15" y="15"></use>
          </svg>
          <div>Nodes</div>
        </div>
        <br>
        <div>
          <svg class="kindInfo">
            <use xlink:href="#vertex-Deployment" x="15" y="15"></use>
          </svg>
          <div>Deploys</div>
        </div>
        <div>
          <svg class="kindInfo">
            <use xlink:href="#vertex-Namespace" x="15" y="15"></use>
          </svg>
          <div>Namespaces</div>
        </div>

      </div>
      {#
      <h3>Topology Overview</h3>
      <div class="topology-overview">
      </div>
      #}
      <h3>Resource Detail</h3>
      <div class="resource-detail" id="resource-detail">
        None selected
      </div>
    </div>
  </div>
  {# ADDONS TAB #}

<style>
.grid {
  margin-bottom: 40px;
}
.addon-item {
  position: relative;
  float: left;
  padding: 20px;
}
.item-icon {
  height: 200px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
}
.item-label {
  padding-top: 10px;
  text-align: center;
}
</style>

  <div class="tab-pane" id="addons">
    <div class="row">
      <div class="col-xs-12">
        <div id="filters" class="btn-group" role="group">
          <a class="btn btn-default" data-filter="*">All</a>
          {% for tag in [] %}
          <a class="btn" data-filter=".{{ tag }}">{{ tag|capitalize }}</a>
          {% endfor %}
        </div>
        <div class="grid clearfix">
          {% for addon in status.addons %}
          <a href="{{ addon.link}}" class="addon-item" data-category="some_tag">
            <div class="item-icon" style="background-image: url('{{ addon.icon }}');"></div>
            <div class="item-label">
              <span>{{ addon.name }}</span>
            </div>
          </a>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12">
        {{ render_form(form) }}
      </div>
    </div>
  </div>
</div>

<svg class="kube-topology" hidden>
  <defs>
    <g class="Node" id="vertex-Node">
      <circle r="15"></circle>
      <text y="7">&#xe621;</text>
    </g>
    <g class="Pod" id="vertex-Pod">
      <circle r="15"></circle>
      <text y="5" x="0.5">&#xf1b3;</text>
    </g>
    <g class="Service" id="vertex-Service">
      <circle r="15"></circle>
      <text y="8" x="-2">&#xe61e;</text>
    </g>
    <g class="Deployment" id="vertex-Deployment">
      <circle r="15"></circle>
      <text y="7.5" x="-1">&#xe624;</text>
    </g>
    <g class="Namespace" id="vertex-Namespace">
      <circle r="15"></circle>
      <text y="7.5" x="-1">&#xf247;</text>
    </g>
  </defs>
</svg>
{% endblock %}

{% block extrajs %}
<script>
jQuery(document).ready(function($){
  // init asPieProgress
  $('.pie_progress').asPieProgress({
    namespace: 'pieProgress',
    barsize: '1',
    size: '120',
    min: 0,
    trackcolor: '#ececea',
    barcolor: '#4bbfaf',
    numberCallback(n) {
      return n;
    }
  });
  $('.pie_progress').asPieProgress('start');

  // init Isotope
  $(document).one("shown.bs.tab", "a[href='#addons']", function(e) {
    var $grid = $('.grid').isotope({
      itemSelector: '.addon-item',
      layoutMode: 'fitRows'
    });
  });

  // bind click actions
  $("#ForcedLayoutGraphBtn").on("click",function (e){
    $("#ForcedLayoutGraphContainer").show();
    $("#HiveGraphContainer").hide();
    $("#HiveGraphBtn").removeClass("active");
    $("#ForcedLayoutGraphBtn").addClass("active");
  });

  $("#HiveGraphBtn").on("click",function (e){
    $("#ForcedLayoutGraphContainer").hide();
    $("#HiveGraphContainer").show();
    $("#ForcedLayoutGraphBtn").removeClass("active")
    $("#HiveGraphBtn").addClass("active");
  });
});

$(document).one("shown.bs.tab", "a[href='#topology']", function(e) {
  d3.json("{{ url_for('api.cluster_topology_data', cluster_id=cluster.id) }}", function(data){
      var changeDetailBox =function (node){
        console.log(node);
        if ('item' in node) {
          $('#resource-detail').html("<dl><dt>Name</dt><dd>" + node.item.metadata.name + "</dd><dt>Kind</dt><dd>" + node.item.kind + "</dd><dt>Namespace</dt><dd>" + node.item.metadata.namespace + "</dd></dl>");
        } else {
          $('#resource-detail').html("<dl><dt>Name</dt><dd>" + node.metadata.name + "</dd><dt>Kind</dt><dd>" + node.kind + "</dd><dt>Namespace</dt><dd>" + node.metadata.namespace + "</dd></dl>");
        }
      };

      K8SVisualisations.forcedChart.init("#topology-graph", data, {nodeClickFn: changeDetailBox});
      K8SVisualisations.hiveChart.init("#HiveChart", data, {nodeClickFn: changeDetailBox});
      $("#HiveGraphContainer").hide();
  });
});
</script>
{% if cluster.state == 'Deploying' %}
<script>
(function(){
  var progressRefreshFn = function(){
    $.get("{{ url_for('ui.cluster_deployment_status', cluster_id=cluster.id) }}", function(res){
      console.log(JSON.stringify(res));
      $('#progress .progress-bar').css('width', res.progress + '%')
      $('#progress .progress-bar-background > span').html(res.progress + '%');
      if(res.result != 'Deploying'){
        clearInterval(interval);
      }
    });
  };
  var interval = setInterval(progressRefreshFn, 10000);
})();
</script>
{% endif %}
{% endblock %}
